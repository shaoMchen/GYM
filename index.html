<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>90KG æ¸›è„‚æ•™ç·´ App v6.1</title>
    <style>
        :root { --primary: #2563eb; --secondary: #10b981; --accent: #f59e0b; --bg: #f1f5f9; --card-bg: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #1e293b; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; font-size: 0.75em; color: #64748b; cursor: pointer; border: none; background: none; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.5em; display: block; margin-bottom: 2px; }
        .page { display: none; padding: 15px; padding-bottom: 100px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--card-bg); padding: 18px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-top: 1px solid #f1f5f9; }
        .h-title { margin: 0 0 15px 0; font-size: 1.3em; color: var(--primary); font-weight: 800; }
        .section-label { font-size: 0.85em; color: #64748b; font-weight: bold; margin: 15px 0 10px 5px; display: block; }
        .ex-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .ex-name { font-weight: bold; color: #1e293b; font-size: 1.1em; }
        .muscle-note { font-size: 0.75em; color: var(--primary); background: #eff6ff; padding: 3px 10px; border-radius: 6px; margin-top: 5px; display: inline-block; font-weight: 500; }
        .log-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .log-box { display: flex; flex-direction: column; font-size: 0.75em; color: #94a3b8; font-weight: bold; }
        input { padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 16px; margin-top: 5px; background: #f8fafc; text-align: center; width: 80%; }
        .day-nav { display: flex; overflow-x: auto; gap: 10px; margin-bottom: 20px; padding-bottom: 5px; }
        .day-btn { padding: 10px 18px; background: white; border: 1.5px solid #e2e8f0; border-radius: 12px; cursor: pointer; white-space: nowrap; font-weight: 600; flex-shrink: 0; }
        .day-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(37,99,235,0.2); }
        .add-panel { background: #fff; padding: 20px; border-radius: 15px; border: 2px dashed var(--primary); margin: 20px 0; }
        select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; margin-top: 10px; font-size: 16px; background: white; }
        .btn-main { width: 100%; padding: 16px; background: var(--secondary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1em; cursor: pointer; }
    </style>
</head>
<body>

<div id="page-workout" class="page active">
    <div class="day-nav">
        <button class="day-btn active" onclick="initDay(1)">é€±ä¸€</button>
        <button class="day-btn" onclick="initDay(2)">é€±äºŒ</button>
        <button class="day-btn" onclick="initDay(3)">é€±ä¸‰</button>
        <button class="day-btn" onclick="initDay(4)">é€±å››</button>
        <button class="day-btn" onclick="initDay(5)">é€±äº”</button>
        <button class="day-btn" onclick="initDay(6)">é€±å…­</button>
        <button class="day-btn" onclick="initDay(0)">é€±æ—¥</button>
    </div>

    <div class="card" style="border-top: 5px solid var(--primary);"><h3 id="todayTitle" style="margin:0"></h3></div>

    <span class="section-label">ğŸ“ é è¨­ä¸»è¦è¨“ç·´</span>
    <div id="defaultList"></div>

    <span class="section-label">ğŸ”¥ è¿½åŠ è¨“ç·´å…§å®¹</span>
    <div id="extraList"></div>

    <div class="add-panel">
        <strong>â• è¿½åŠ å‹•ä½œï¼š</strong>
        <select id="partPicker" onchange="updateActionPicker()">
            <option value="">1. é¸æ“‡éƒ¨ä½</option>
            <option value="chest">èƒ¸éƒ¨</option><option value="back">èƒŒéƒ¨</option><option value="leg">ä¸‹è‚¢</option><option value="shoulder">è‚©è†€</option><option value="core">æ ¸å¿ƒ</option>
        </select>
        <select id="actionPicker" onchange="addExtraAction()" disabled><option value="">2. é¸æ“‡å‹•ä½œ</option></select>
    </div>
    <button class="btn-main" onclick="saveWorkout()">ğŸ’¾ å„²å­˜ä»Šæ—¥ç´€éŒ„</button>
</div>

<div id="page-status" class="page">
    <h2 class="h-title">ğŸ“ˆ é€²åº¦è¿½è¹¤</h2>
    <div class="card">
        <span class="section-label">èº«é«”çµ„æˆ</span>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="log-box">é«”é‡(kg)<input type="number" id="w-val" value="90" oninput="updateStats()"></div>
            <div class="log-box">é«”è„‚(%)<input type="number" id="f-val" value="32.7" oninput="updateStats()"></div>
        </div>
        <p id="stat-text" style="margin-top:15px; font-size:0.9em; color:#475569;"></p>
    </div>
    <div class="card">
        <span class="section-label">ğŸ’ª 1RM è¨ˆç®—æ©Ÿ</span>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <input type="number" id="rm-w" placeholder="é‡é‡">
            <input type="number" id="rm-r" placeholder="æ¬¡æ•¸">
        </div>
        <button onclick="calcRM()" style="margin-top:15px; width:100%; padding:10px;">è¨ˆç®—</button>
        <h2 id="rm-res" style="text-align:center; color:var(--primary);">--</h2>
    </div>
</div>

<div id="page-nutrition" class="page">
    <h2 class="h-title">ğŸ¥— è›‹ç™½è³ªç²¾æº–ç®¡ç†</h2>
    
    <div class="card" style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white; border:none;">
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div>
                <span style="opacity: 0.9; font-size: 0.9em;">ä»Šæ—¥å·²æ”å–</span>
                <h1 style="margin:5px 0;"><span id="p-eaten">0</span> <small style="font-size:0.5em;">/ <span id="p-target-val">144</span> g</small></h1>
            </div>
            <div style="text-align: right;">
                <span id="p-percent" style="font-weight: bold; font-size: 1.2em;">0%</span>
            </div>
        </div>
        <div style="background: rgba(255,255,255,0.2); height: 12px; border-radius: 6px; margin-top: 10px; overflow: hidden;">
            <div id="p-progress-bar" style="background: #10b981; width: 0%; height: 100%; transition: 0.8s ease-out;"></div>
        </div>
    </div>

    <div class="card">
        <span class="section-label">âš¡ å¿«é€Ÿæ›ç®—ä¸¦ç´€éŒ„</span>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <select id="food-type" style="margin:0;">
                <option value="protein_meat">é›èƒ¸è‚‰ (æ¯ 100g)</option>
                <option value="protein_egg">é›è›‹ (æ¯ 1 é¡†)</option>
                <option value="protein_yogurt">å¸Œè‡˜å„ªæ ¼ (æ¯ 100g)</option>
                <option value="protein_powder">ä¹³æ¸…è›‹ç™½ (æ¯ 1 åŒ™)</option>
            </select>
            <input type="number" id="food-qty" placeholder="ä»½é‡/æ•¸å€¼" oninput="calcProtein()">
        </div>
        <p id="calc-res" style="text-align: center; margin: 15px 0; font-weight: bold; color: var(--primary); min-height: 1.2em;"></p>
        <button class="btn-main" onclick="addProteinRecord()" style="background: var(--primary);">â• ä¸€éµåŠ å…¥ä»Šæ—¥ç´¯ç©</button>
        <button onclick="resetProtein()" style="width:100%; background:none; border:none; color:#94a3b8; font-size:0.8em; margin-top:15px; text-decoration: underline;">æ¸…é™¤ä»Šæ—¥ç´€éŒ„ï¼Œé‡æ–°é–‹å§‹</button>
    </div>

    <div class="card">
        <span class="section-label">ğŸ•’ è¨“ç·´è£œçµ¦æ™‚é–“è»¸</span>
        <div style="border-left: 2px solid #e2e8f0; margin-left: 10px; padding-left: 20px;">
            <div style="margin-bottom: 15px;">
                <b style="color: var(--primary);">è¨“å‰ 1 å°æ™‚</b><br>
                <small>ä¸­é‡ç¢³æ°´ï¼ˆåœ°ç“œã€é¦™è•‰ï¼‰ï¼Œé¿å…é‹å‹•ä¸­é£¢é¤“ã€‚</small>
            </div>
            <div style="margin-bottom: 15px;">
                <b style="color: var(--secondary);">è¨“ç·´ä¸­</b><br>
                <small>æ¯ 15 åˆ†é˜è£œæ°´ 200ccï¼Œä¿æŒä»£è¬æ•ˆç‡ã€‚</small>
            </div>
            <div>
                <b style="color: var(--accent);">è¨“å¾Œ 30 åˆ†é˜</b><br>
                <small>é«˜å¸æ”¶è›‹ç™½ + å°‘é‡ç¢³æ°´ï¼Œä¿®å¾©å—æè‚Œè‚‰ã€‚</small>
            </div>
        </div>
    </div>
</div>

<div id="page-info" class="page">
    <h2 class="h-title">ğŸ’¡ è¨“ç·´åŠ©æ‰‹èˆ‡çŸ¥è­˜</h2>
    
    <div class="card" style="border-left: 5px solid var(--accent);">
        <span class="section-label">â±ï¸ ç°¡æ˜“é–“æ­‡è¨ˆæ™‚å™¨ (HIIT ç”¨)</span>
        <div style="text-align: center;">
            <h1 id="timer-display" style="font-size: 3em; margin: 10px 0;">40</h1>
            <div style="display: flex; gap: 10px;">
                <button class="day-btn" style="flex:1" onclick="startTimer(40, '#ef4444')">é‹å‹• (40s)</button>
                <button class="day-btn" style="flex:1" onclick="startTimer(20, '#10b981')">ä¼‘æ¯ (20s)</button>
                <button class="day-btn" style="flex:1" onclick="resetTimer()">é‡è¨­</button>
            </div>
        </div>
    </div>

    <div class="card">
        <span class="section-label">ğŸ“ˆ æ¸›è„‚é€²åº¦è¡¨ (10% é«”è„‚ç›®æ¨™)</span>
        <div style="display: flex; justify-content: space-between; font-size: 0.8em; margin-bottom: 5px;">
            <span>èµ·é»: 32.7%</span>
            <span>ç›®å‰</span>
            <span>ç›®æ¨™: 22.7%</span>
        </div>
        <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden;">
            <div id="fat-progress-bar" style="background: var(--primary); width: 0%; height: 100%; transition: 1s;"></div>
        </div>
        <p style="font-size: 0.8em; color: #64748b; margin-top: 10px; text-align: center;">
            ğŸ’¡ æ¯é€±æ¸›å°‘ 0.5kg ~ 1kg ç‚ºæœ€å¥åº·çš„æ¸›è„‚é€Ÿåº¦ã€‚
        </p>
    </div>

    <div class="card">
        <span class="section-label">ğŸ“Œ æ»‘é›ªæ©Ÿ SkiErg å§¿å‹¢è¦é»</span>
        <ul style="font-size: 0.85em; padding-left: 20px; line-height: 1.8;">
            <li><b>å•Ÿå‹•ï¼š</b>é›™æ‰‹èˆ‡çœ¼åŒé«˜ï¼Œæ ¸å¿ƒæ”¶ç·Šã€‚</li>
            <li><b>ç™¼åŠ›ï¼š</b>é‹ç”¨é«”é‡ä¸‹å£“ï¼Œè€Œä¸åƒ…æ˜¯é æ‰‹è‡‚æ‹‰ã€‚</li>
            <li><b>çµæŸï¼š</b>æ‹‰åˆ°å¤§è…¿å…©å´ï¼Œé †å‹¢æ›²è†ç·©è¡ã€‚</li>
            <li><b>ç¯€å¥ï¼š</b>åæ°£ä¸‹å£“ï¼Œå¸æ°£å›å½ˆã€‚</li>
        </ul>
    </div>
</div>

<div id="page-history" class="page">
    <h2 class="h-title">ğŸ“… æ­·å²è¨“ç·´æª”æ¡ˆ</h2>
    <div class="card" style="background: #f8fafc;">
        <span class="section-label">æ•¸æ“šçµ±è¨ˆ</span>
        <p id="history-stats" style="font-size: 0.9em; color: #475569;">è¼‰å…¥ä¸­...</p>
    </div>
    <div id="history-container">
        </div>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" onclick="switchPage('workout')"><span class="nav-icon">ğŸ‹ï¸</span>è¨“ç·´</button>
    <button class="nav-item" onclick="switchPage('history')"><span class="nav-icon">ğŸ“œ</span>æ­·å²</button>
    <button class="nav-item" onclick="switchPage('status')"><span class="nav-icon">ğŸ“Š</span>æ•¸æ“š</button>
    <button class="nav-item" onclick="switchPage('nutrition')"><span class="nav-icon">ğŸ¥—</span>ç‡Ÿé¤Š</button>
    <button class="nav-item" onclick="switchPage('info')"><span class="nav-icon">ğŸ’¡</span>åƒè€ƒ</button>
</nav>

<script>
    const masterLib = {
        chest: [{name:"æ©Ÿæ¢°æ¨èƒ¸",note:"å…¨èƒ¸"}, {name:"ä¸Šæ–œå•éˆ´æ¨",note:"ä¸Šèƒ¸"}],
        back: [{name:"æ»‘è¼ªä¸‹æ‹‰",note:"èƒŒå¯¬"}, {name:"æ©Ÿæ¢°åˆ’èˆ¹",note:"èƒŒåš"}],
        leg: [{name:"æ©Ÿæ¢°è…¿æ¨",note:"å¤§è…¿"}, {name:"åˆ†è…¿è¹²",note:"ç‡ƒè„‚"}],
        shoulder: [{name:"æ©Ÿæ¢°è‚©æ¨",note:"è‚©è†€"}, {name:"å´å¹³èˆ‰",note:"è‚©å¯¬"}],
        core: [{name:"æ»‘è¼ªæœ¨å‰",note:"æ–œè…¹"}, {name:"å¹³æ¿æ”¯æ’",note:"æ ¸å¿ƒ"}]
    };

const presets = {
    1: { 
        title: "é€±ä¸€ï¼šç´”ã€Œæ¨ã€å¤§è‚Œç¾¤ (èƒ¸/è‚©)", 
        actions: [
            {name:"åå§¿æ¨èƒ¸æ©Ÿ", note:"èƒ¸éƒ¨ä¸»é …ï¼Œå»ºç«‹åŸºç¤åŠ›é‡", type:"strength"},
            {name:"ä¸Šæ–œå•éˆ´è‡¥æ¨", note:"å¼·åŒ–ä¸Šèƒ¸ï¼Œè¦–è¦ºæ›´æŒºæ‹”", type:"strength"},
            {name:"æ©Ÿæ¢°å¤¾èƒ¸", note:"é›•å¡‘èƒ¸è‚Œä¸­ç¸«ç´°ç¯€", type:"strength"},
            {name:"æ©Ÿæ¢°åå§¿è‚©æ¨", note:"å¢åŠ è‚©è†€åšåº¦ï¼Œé¡¯è…°ç˜¦", type:"strength"},
            {name:"å•éˆ´å´å¹³èˆ‰", note:"é›•å¡‘è‚©è†€å¯¬åº¦", type:"strength"},
            {name:"è¼”åŠ©æ”¯æ’æ’é«”", note:"ç‹ç‰Œå‹•ä½œï¼šåˆºæ¿€ä¸‹èƒ¸èˆ‡è‚©å‰", type:"strength"},
            {name:"æ»‘é›ªæ©Ÿ (15m)", note:"ç‡ƒè„‚çµå°¾ï¼šå¿ƒç‡ç¶­æŒ 135+", type:"cardio"}
        ] 
    },
    2: { 
        title: "é€±äºŒï¼šç´”ã€Œæ‹‰ã€å¤§è‚Œç¾¤ (èƒŒ/å¾Œä¸‰è§’)", 
        actions: [
            {name:"æ»‘ç›¤ HIIT", note:"å¿ƒè‚ºä»£è¬è£œå„Ÿ", type:"hiit"},
            {name:"å¯¬æ¡æ»‘è¼ªä¸‹æ‹‰", note:"å¢åŠ èƒŒå¯¬ï¼Œæé«˜ä»£è¬", type:"strength"},
            {name:"åå§¿åˆ’èˆ¹æ©Ÿ", note:"é‡å°èƒŒéƒ¨åšåº¦", type:"strength"},
            {name:"æ©Ÿæ¢°åˆ’èˆ¹", note:"å¼·å¤§è¤‡åˆå‹•ä½œï¼Œç‡ƒè„‚æ¥µä½³", type:"strength"},
            {name:"è‡‰æ‹‰ (Face Pull)", note:"ä¿è­·è‚©é—œç¯€ï¼Œç©©å®šæ®æ‹", type:"strength"},
            {name:"æ‡¸å‚èˆ‰è…¿", note:"å¼·åŒ–æ ¸å¿ƒï¼Œæ”¯æ’é«”é‡", type:"strength"},
            {name:"æ»‘é›ªæ©Ÿ (15m)", note:"ç‡ƒè„‚çµå°¾", type:"cardio"}
        ] 
    },
    3: { 
        title: "é€±ä¸‰ï¼šä¸»å‹•å¼æ¢å¾©", 
        actions: [
            {name:"æ»¾ç­’ç­‹è†œæ”¾é¬†", note:"å…¨èº«å¤§è‚Œç¾¤æŒ‰å£“", type:"strength"},
            {name:"éœæ…‹ä¼¸å±•", note:"æ”¹å–„è¨“ç·´å¾Œçš„ç·Šç¹ƒ", type:"strength"}
        ] 
    },
    4: { 
        title: "é€±å››ï¼šä¸‹è‚¢å°ˆé … (è…¿/è‡€)", 
        actions: [
            {name:"æ©Ÿæ¢°è…¿æ¨", note:"å®‰å…¨ä¸Šå¤§é‡é‡ï¼Œç‡ƒè„‚ç‹", type:"strength"},
            {name:"é«˜æ¯æ·±è¹²", note:"å¼·åŒ–è‚¡å››é ­èˆ‡æ ¸å¿ƒç©©å®š", type:"strength"},
            {name:"ä¿¯è‡¥è…¿å¾Œå½èˆ‰", note:"å¹³è¡¡å‰å¾Œå´ï¼Œé é˜²å—å‚·", type:"strength"},
            {name:"ä¿åŠ åˆ©äºåˆ†è…¿è¹²", note:"æ¥µè‡´å¿ƒç‡ï¼Œå¼·åŒ–å–®è…³ç©©å®š", type:"strength"},
            {name:"æ©Ÿæ¢°èƒŒéƒ¨ä¼¸å±•", note:"å¼·åŒ–ä¸‹èƒŒï¼Œæ”¯æ’é«”é‡", type:"strength"},
            {name:"æ»‘é›ªæ©Ÿ (10m)", note:"é«˜å¼·åº¦è¡åˆºçµå°¾", type:"cardio"}
        ] 
    },
    5: { 
        title: "é€±äº”ï¼šå…¨èº«åŠŸèƒ½èˆ‡ HIIT", 
        actions: [
            {name:"æ»‘ç›¤ HIIT", note:"å¿ƒè‚ºä»£è¬è£œå„Ÿ", type:"hiit"},
            {name:"å…­è§’æ§“ç¡¬èˆ‰", note:"å…¨èº«å¤§åŠ›é‡å¾µå¬", type:"strength"},
            {name:"æ»‘é›ªæ©Ÿ (20m)", note:"ç•¶é€±æœ€å¾Œè€åŠ›æŒ‘æˆ°", type:"cardio"}
        ] 
    },
    6: { 
        title: "é€±å…­ï¼šç¾½çƒé‹å‹•æ—¥", 
        actions: [{name:"ç¾½çƒå°ˆé …é‹å‹•", note:"é«˜å¼·åº¦é–“æ­‡å¿ƒè‚º", type:"cardio"}] 
    },
    0: { 
        title: "é€±æ—¥ï¼šä½å¼·åº¦æ´»å‹• (LISS)", 
        actions: [{name:"å¡åº¦å¿«èµ°", note:"è„‚è‚ªæ°§åŒ–å€é–“", type:"cardio"}] 
    }
};

    let currentDay = 1;

    function switchPage(p) {
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(nv => nv.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        event.currentTarget.classList.add('active');
	if (p === 'history') {
        renderHistory();
    }
    }

    function renderHistory() {
    const container = document.getElementById('history-container');
    const statsText = document.getElementById('history-stats');
    container.innerHTML = '';
    
    const allKeys = Object.keys(localStorage).filter(k => k.match(/^\d{4}-\d{2}-\d{2}/)); // åŒ¹é… YYYY-MM-DD
    allKeys.sort().reverse(); // æŒ‰æ—¥æœŸå€’åºæ’

    if (allKeys.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#94a3b8; margin-top:20px;">å°šç„¡æ­·å²ç´€éŒ„ï¼Œé–‹å§‹ä»Šæ—¥è¨“ç·´å§ï¼</p>';
        statsText.innerText = "ç›®å‰é‚„æ²’æœ‰ç´€éŒ„å–”ã€‚";
        return;
    }

    statsText.innerText = `ç¸½å…±å·²å®Œæˆ ${allKeys.length} é …è¨“ç·´å‹•ä½œç´€éŒ„ã€‚`;

    let lastDate = "";
    allKeys.forEach(key => {
        const datePart = key.split('-').slice(0, 3).join('-'); // æå–æ—¥æœŸéƒ¨åˆ†
        const data = JSON.parse(localStorage.getItem(key));
        
        // å¦‚æœæ˜¯æ–°æ—¥æœŸï¼Œé¡¯ç¤ºæ—¥æœŸæ¨™ç±¤
        if (datePart !== lastDate) {
            const dateHeader = document.createElement('div');
            dateHeader.className = 'section-label';
            dateHeader.style = "margin-top: 25px; color: var(--primary); font-size: 1em; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px;";
            dateHeader.innerText = `ğŸ“… ${datePart}`;
            container.appendChild(dateHeader);
            lastDate = datePart;
        }

        // æ ¹æ“š key çš„å¾Œç¶´æ‰¾å‡ºå‹•ä½œåç¨± (å¾ presets åŒ¹é…æˆ–å„²å­˜æ™‚å¢åŠ åç¨±)
        // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘åœ¨ saveItem æ™‚å¤šå­˜ä¸€å€‹åç¨±é€²å»
        const itemCard = document.createElement('div');
        itemCard.className = 'card';
        itemCard.style = "padding: 12px; margin-bottom: 8px; border-left: 4px solid #cbd5e1;";
        
        // åˆ¤æ–·æŒ‡æ¨™é¡å‹ (é‡é‡/æ™‚é–“/å¾ªç’°)
        let displayUnits = `é‡: ${data.v1} | çµ„: ${data.v2} | æ¬¡: ${data.v3}`;
        
        itemCard.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold; font-size:0.95em; color:#1e293b;">${key.split('-').slice(3).join('-')}</span>
                <span style="font-size:0.85em; color:#64748b;">${displayUnits}</span>
            </div>
        `;
        container.appendChild(itemCard);
    });
}

    function initDay(d) {
        currentDay = d;
        document.querySelectorAll('.day-btn').forEach((btn, i) => {
            btn.classList.toggle('active', [1,2,3,4,5,6,0][i] === d);
        });
        document.getElementById('todayTitle').innerText = presets[d].title;
        renderWorkout();
    }

    function renderWorkout() {
        const defContainer = document.getElementById('defaultList');
        defContainer.innerHTML = '';
        presets[currentDay].actions.forEach((ex, i) => {
            defContainer.innerHTML += createCardHTML(ex, `def-${currentDay}-${i}`);
        });

        const extraContainer = document.getElementById('extraList');
        const extras = JSON.parse(localStorage.getItem(`v6-extras-${currentDay}`)) || [];
        extraContainer.innerHTML = '';
        extras.forEach((ex, i) => {
            extraContainer.innerHTML += createCardHTML(ex, `ext-${currentDay}-${i}`, true, i);
        });
    }

    function createCardHTML(ex, key, isExt = false, idx = null) {
    // å„ªå…ˆè®€å–ã€Œä¸Šæ¬¡ç´€éŒ„ã€ï¼Œä½œç‚ºé è¨­å€¼é¡¯ç¤º
    const lastData = JSON.parse(localStorage.getItem(`last-${key}`)) || {v1:'', v2:'', v3:''};
    
    let label1 = "é‡é‡(kg)", label2 = "çµ„æ•¸", label3 = "æ¬¡æ•¸";
    if(ex.type === 'cardio' || ex.name.includes("æ»‘é›ªæ©Ÿ")) { 
        label1 = "æ™‚é–“(m)"; label2 = "é˜»åŠ›"; label3 = "å¿ƒç‡"; 
    }

    return `
        <div class="card">
            <div class="ex-header">
                <div>
                    <span class="ex-name">${ex.name}</span><br>
                    <span class="muscle-note">ğŸ“Œ ${ex.note}</span>
                </div>
            </div>
            <div style="font-size:0.7em; color:var(--primary); margin-bottom:5px;">ä¸Šæ¬¡ç´€éŒ„: ${lastData.v1 || '--'} / ${lastData.v2 || '--'} / ${lastData.v3 || '--'}</div>
            <div class="log-grid">
                <div class="log-box">${label1}<input id="v1-${key}" placeholder="${lastData.v1}"></div>
                <div class="log-box">${label2}<input id="v2-${key}" placeholder="${lastData.v2}"></div>
                <div class="log-box">${label3}<input id="v3-${key}" placeholder="${lastData.v3}"></div>
            </div>
        </div>`;
}

    function addExtraAction() {
        const picker = document.getElementById('actionPicker');
        if(!picker.value) return;
        const extras = JSON.parse(localStorage.getItem(`v6-extras-${currentDay}`)) || [];
        extras.push(JSON.parse(picker.value));
        localStorage.setItem(`v6-extras-${currentDay}`, JSON.stringify(extras));
        picker.value = "";
        renderWorkout();
    }

    function removeExtra(idx) {
        const extras = JSON.parse(localStorage.getItem(`v6-extras-${currentDay}`)) || [];
        extras.splice(idx, 1);
        localStorage.setItem(`v6-extras-${currentDay}`, JSON.stringify(extras));
        renderWorkout();
    }

    function saveWorkout() {
        presets[currentDay].actions.forEach((_, i) => saveItem(`def-${currentDay}-${i}`));
        const extras = JSON.parse(localStorage.getItem(`v6-extras-${currentDay}`)) || [];
        extras.forEach((_, i) => saveItem(`ext-${currentDay}-${i}`));
        alert('âœ… å„²å­˜æˆåŠŸ');
    }

    function saveItem(k) {
    const today = new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'}).replace(/\//g, '-');
    
    // ç²å–å‹•ä½œåç¨±ï¼ˆå¾ DOM æŠ“å–ï¼‰
    const actionName = document.querySelector(`#v1-${k}`).closest('.card').querySelector('.ex-name').innerText;
    const dateKey = `${today}-${actionName}`; // ä¾‹å¦‚ï¼š2024-05-20-åå§¿æ¨èƒ¸æ©Ÿ
    
    const data = {
        v1: document.getElementById(`v1-${k}`).value || '0',
        v2: document.getElementById(`v2-${k}`).value || '0',
        v3: document.getElementById(`v3-${k}`).value || '0'
    };
    
    localStorage.setItem(dateKey, JSON.stringify(data));
    localStorage.setItem(`last-${k}`, JSON.stringify(data)); // åŒæ­¥æ›´æ–°ä¸‹é€±åƒè€ƒ
}
    function updateActionPicker() {
        const p = document.getElementById('partPicker').value;
        const picker = document.getElementById('actionPicker');
        picker.innerHTML = '<option value="">2. é¸æ“‡å‹•ä½œ</option>';
        if(p) {
            picker.disabled = false;
            masterLib[p].forEach(ex => picker.innerHTML += `<option value='${JSON.stringify(ex)}'>${ex.name}</option>`);
        }
    }

    function calcRM() {
        const w = document.getElementById('rm-w').value;
        const r = document.getElementById('rm-r').value;
        if(w && r) document.getElementById('rm-res').innerText = Math.round(w * (1 + r/30)) + " kg";
    }

// åˆå§‹åŒ–è›‹ç™½è³ªæ•¸æ“š
let dailyProtein = parseFloat(localStorage.getItem('daily_protein_total')) || 0;

function calcProtein() {
    const type = document.getElementById('food-type').value;
    const qty = parseFloat(document.getElementById('food-qty').value);
    const calcRes = document.getElementById('calc-res');
    
    if (!qty || qty <= 0) {
        calcRes.innerText = "";
        return;
    }

    let proteinPerUnit = 0;
    if (type === "protein_meat") proteinPerUnit = 0.25;
    if (type === "protein_egg") proteinPerUnit = 7;
    if (type === "protein_yogurt") proteinPerUnit = 0.1;
    if (type === "protein_powder") proteinPerUnit = 24;

    const result = Math.round(qty * proteinPerUnit);
    calcRes.innerText = `é€™ä»½å«æœ‰ç´„ ${result} g è›‹ç™½è³ª`;
    return result;
}

function addProteinRecord() {
    const amount = calcProtein();
    if (amount > 0) {
        dailyProtein += amount;
        saveAndRefreshProtein();
        
        // æ¸…ç©ºè¼¸å…¥æ¡†
        document.getElementById('food-qty').value = "";
        document.getElementById('calc-res').innerText = "âœ… å·²åŠ å…¥ï¼";
        setTimeout(() => { document.getElementById('calc-res').innerText = ""; }, 2000);
    } else {
        alert("è«‹å…ˆè¼¸å…¥ä»½é‡");
    }
}

function saveAndRefreshProtein() {
    // å„²å­˜åˆ°æœ¬åœ°
    localStorage.setItem('daily_protein_total', dailyProtein);
    
    // æ›´æ–°é¡¯ç¤ºæ–‡å­—
    document.getElementById('p-eaten').innerText = dailyProtein;
    
    // è¨ˆç®—ç›®æ¨™é”æˆç‡
    const weight = document.getElementById('w-val').value || 90;
    const target = Math.round(weight * 1.6);
    document.getElementById('p-target-val').innerText = target;
    
    const percent = Math.round((dailyProtein / target) * 100);
    document.getElementById('p-percent').innerText = percent + "%";
    
    // æ›´æ–°é€²åº¦æ¢
    const bar = document.getElementById('p-progress-bar');
    bar.style.width = Math.min(percent, 100) + "%";
    
    // é”æˆç›®æ¨™è®Šè‰²é¼“å‹µ
    if (percent >= 100) {
        bar.style.background = "#f59e0b"; // è®Šæˆé‡‘é»ƒè‰²
    } else {
        bar.style.background = "#10b981"; // é è¨­ç¶ è‰²
    }
}

function resetProtein() {
    if (confirm("ç¢ºå®šè¦æ¸…é™¤ä»Šå¤©çš„è›‹ç™½è³ªç´¯ç©ç´€éŒ„å—ï¼Ÿ")) {
        dailyProtein = 0;
        saveAndRefreshProtein();
    }
}

// ä¿®æ”¹åŸæœ‰çš„ window.onload ç¢ºä¿å•Ÿå‹•æ™‚è®€å–æ•¸æ“š
const originalOnload = window.onload;
window.onload = () => {
    if (originalOnload) originalOnload();
    saveAndRefreshProtein(); // åˆå§‹åŒ–è›‹ç™½è³ªé¢æ¿
};

// ä¿®æ”¹ updateStats è®“é«”é‡æ”¹è®Šæ™‚ï¼Œè›‹ç™½è³ªç›®æ¨™åŒæ­¥æ›´æ–°
function updateStats() {
    const w = document.getElementById('w-val').value || 90;
    const f = document.getElementById('f-val').value || 32.7;
    document.getElementById('p-target').innerText = Math.round(w * 1.6); // èˆŠç‰ˆæ¨™ç±¤ç›¸å®¹
    document.getElementById('stat-text').innerText = `ç›®å‰ï¼š${w}kg / ${f}%ã€‚ ç›®æ¨™é«”è„‚ï¼š22.7%ã€‚`;
    saveAndRefreshProtein(); // åŒæ­¥æ›´æ–°è›‹ç™½è³ªç›®æ¨™é¡¯ç¤º
}
// é¡å¤–åŠ å¼·ï¼šè®“é ‚éƒ¨é€²åº¦æ¢æœƒå‹•
function updateProteinProgressBar(currentInTake) {
    const target = parseFloat(document.getElementById('p-target').innerText);
    const bar = document.getElementById('p-progress');
    // æ³¨æ„ï¼šé€™è£¡åƒ…ç‚ºç¤ºæ„å–®æ¬¡æ”å–ä½”æ¯”ï¼Œå¯¦éš›æ‡‰ç´¯ç©è¨ˆç®—
    let percent = (currentInTake / target) * 100;
    bar.style.width = Math.min(100, percent) + '%';
}

// --- åƒè€ƒé é¢è¨ˆæ™‚å™¨åŠŸèƒ½ ---
let timerInterval;
function startTimer(seconds, color) {
    clearInterval(timerInterval);
    let timeLeft = seconds;
    const display = document.getElementById('timer-display');
    display.style.color = color;
    
    timerInterval = setInterval(() => {
        timeLeft--;
        display.innerText = timeLeft;
        if(timeLeft <= 0) {
            clearInterval(timerInterval);
            display.innerText = "å®Œæˆ!";
            // æ’­æ”¾éœ‡å‹•æˆ–æç¤ºéŸ³ (æ‰‹æ©Ÿæ”¯æ´æ™‚)
            if(navigator.vibrate) navigator.vibrate(200);
        }
    }, 1000);
}

function resetTimer() {
    clearInterval(timerInterval);
    document.getElementById('timer-display').innerText = "40";
    document.getElementById('timer-display').style.color = "#1e293b";
}

// --- é€²åº¦æ¢æ›´æ–°åŠŸèƒ½ ---
function updateProgressBars() {
    const currentFat = document.getElementById('f-val').value || 32.7;
    const startFat = 32.7;
    const targetFat = 22.7;
    
    // è¨ˆç®—é«”è„‚é€²åº¦
    let progress = ((startFat - currentFat) / (startFat - targetFat)) * 100;
    progress = Math.max(0, Math.min(100, progress)); // é™åˆ¶åœ¨ 0-100
    document.getElementById('fat-progress-bar').style.width = progress + '%';
}

// ä¿®æ”¹åŸæœ‰çš„ updateStats åŠ ä¸Šé€²åº¦æ¢å‘¼å«
const originalUpdateStats = updateStats;
updateStats = function() {
    originalUpdateStats();
    updateProgressBars();
}; 

    function updateStats() {
        const w = document.getElementById('w-val').value || 90;
        const f = document.getElementById('f-val').value || 32.7;
        document.getElementById('p-target').innerText = Math.round(w * 1.6);
        document.getElementById('stat-text').innerText = `ç›®å‰ï¼š${w}kg / ${f}%ã€‚ ç›®æ¨™é«”è„‚ï¼š22.7%ã€‚`;
    }

    window.onload = () => { initDay(1); updateStats(); };
</script>
</body>
</html>
